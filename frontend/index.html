<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ResumeAI Pro - AI-Powered Resume Screening</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- PDF Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- App Config -->
  <script src="js/firebase-config.js"></script>
  <script src="js/auth.js"></script>
  <script>
    // Protect route
    document.addEventListener('DOMContentLoaded', checkAuth);
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #0a0a0f;
      --bg-secondary: #06060a;
      --surface: #12121a;
      --surface-hover: #1a1a24;
      --border: #2a2a3a;
      --border-soft: #1e1e2a;
      --text: #ffffff;
      --text-muted: #8a8a9a;
      --text-soft: #6a6a7a;
      --primary: #6366f1;
      --primary-hover: #818cf8;
      --primary-glow: rgba(99, 102, 241, 0.4);
      --primary-subtle: rgba(99, 102, 241, 0.08);
      --success: #22c55e;
      --success-subtle: rgba(34, 197, 94, 0.1);
      --warning: #eab308;
      --warning-subtle: rgba(234, 179, 8, 0.1);
      --danger: #ef4444;
      --danger-subtle: rgba(239, 68, 68, 0.1);
      --gradient-1: #6366f1;
      --gradient-2: #8b5cf6;
      --gradient-3: #a855f7;
      --secondary: #ec4899;
    }

    [data-theme="light"] {
      --bg: #f8fafc;
      --bg-secondary: #f1f5f9;
      --surface: #ffffff;
      --surface-hover: #f8fafc;
      --border: #e2e8f0;
      --border-soft: #f1f5f9;
      --text: #0f172a;
      --text-muted: #64748b;
      --text-soft: #94a3b8;
      --primary: #4f46e5;
      --primary-hover: #6366f1;
      --primary-glow: rgba(79, 70, 229, 0.2);
      --primary-subtle: rgba(79, 70, 229, 0.05);
      --success-subtle: rgba(34, 197, 94, 0.08);
      --warning-subtle: rgba(234, 179, 8, 0.08);
      --danger-subtle: rgba(239, 68, 68, 0.08);
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
      transition: background 0.4s ease, color 0.4s ease;
    }

    /* Animated Background */
    .animated-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
      pointer-events: none;
    }

    .wave {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 200%;
      height: 100%;
      background: linear-gradient(180deg, transparent 70%, var(--primary-glow) 100%);
      opacity: 0.1;
    }

    .wave:nth-child(1) {
      animation: wave 25s ease-in-out infinite;
      bottom: -5%;
    }

    .wave:nth-child(2) {
      animation: wave 30s ease-in-out infinite reverse;
      bottom: -15%;
      opacity: 0.07;
    }

    .wave:nth-child(3) {
      animation: wave 35s ease-in-out infinite;
      bottom: -25%;
      opacity: 0.05;
    }

    @keyframes wave {

      0%,
      100% {
        transform: translateX(0) translateY(0);
      }

      50% {
        transform: translateX(-3%) translateY(8px);
      }
    }

    .bubble {
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, var(--gradient-2), var(--gradient-1));
      opacity: 0.04;
    }

    .bubble:nth-child(4) {
      width: 60px;
      height: 60px;
      left: 5%;
      top: 15%;
      animation: floatBubble 35s ease-in-out infinite;
    }

    .bubble:nth-child(5) {
      width: 100px;
      height: 100px;
      left: 85%;
      top: 55%;
      animation: floatBubble 40s ease-in-out infinite -5s;
    }

    .bubble:nth-child(6) {
      width: 45px;
      height: 45px;
      left: 45%;
      top: 75%;
      animation: floatBubble 32s ease-in-out infinite -10s;
    }

    .bubble:nth-child(7) {
      width: 80px;
      height: 80px;
      left: 25%;
      top: 45%;
      animation: floatBubble 38s ease-in-out infinite -15s;
    }

    .bubble:nth-child(8) {
      width: 55px;
      height: 55px;
      left: 75%;
      top: 25%;
      animation: floatBubble 42s ease-in-out infinite -8s;
    }

    .bubble:nth-child(9) {
      width: 70px;
      height: 70px;
      left: 15%;
      top: 65%;
      animation: floatBubble 36s ease-in-out infinite -12s;
    }

    .bubble:nth-child(10) {
      width: 40px;
      height: 40px;
      left: 55%;
      top: 10%;
      animation: floatBubble 30s ease-in-out infinite -3s;
    }

    .bubble:nth-child(11) {
      width: 90px;
      height: 90px;
      left: 90%;
      top: 80%;
      animation: floatBubble 45s ease-in-out infinite -18s;
    }

    .bubble:nth-child(12) {
      width: 35px;
      height: 35px;
      left: 35%;
      top: 30%;
      animation: floatBubble 33s ease-in-out infinite -7s;
    }

    .bubble:nth-child(13) {
      width: 65px;
      height: 65px;
      left: 65%;
      top: 60%;
      animation: floatBubble 37s ease-in-out infinite -14s;
    }

    .bubble:nth-child(14) {
      width: 50px;
      height: 50px;
      left: 10%;
      top: 85%;
      animation: floatBubble 34s ease-in-out infinite -20s;
    }

    .bubble:nth-child(15) {
      width: 75px;
      height: 75px;
      left: 80%;
      top: 5%;
      animation: floatBubble 39s ease-in-out infinite -9s;
    }

    @keyframes floatBubble {

      0%,
      100% {
        transform: translateY(0) translateX(0) scale(1);
      }

      25% {
        transform: translateY(-15px) translateX(8px) scale(1.02);
      }

      50% {
        transform: translateY(-8px) translateX(-5px) scale(0.98);
      }

      75% {
        transform: translateY(-20px) translateX(5px) scale(1.01);
      }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
    }

    /* Header */
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
      transition: all 0.4s ease;
    }

    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, var(--gradient-1), var(--gradient-2), var(--gradient-3));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px var(--primary-glow);
      transition: transform 0.4s ease, box-shadow 0.4s ease;
    }

    .logo:hover .logo-icon {
      transform: scale(1.05) rotate(3deg);
      box-shadow: 0 6px 25px var(--primary-glow);
    }

    .logo h1 {
      font-size: 22px;
      font-weight: 700;
      position: relative;
      text-decoration: underline;
      text-decoration-color: var(--primary);
      text-underline-offset: 4px;
      text-decoration-thickness: 2px;
      transition: all 0.4s ease;
      cursor: pointer;
    }

    .logo h1::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--gradient-1), var(--gradient-2), var(--gradient-3));
      transition: width 0.5s ease;
    }

    .logo:hover h1::after {
      width: 100%;
    }

    .logo:hover h1 {
      text-shadow: 0 0 20px var(--primary-glow);
      text-decoration-color: transparent;
    }

    .logo span {
      background: linear-gradient(135deg, var(--gradient-1), var(--gradient-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .theme-controls {
      display: flex;
      gap: 4px;
      background: var(--bg);
      padding: 4px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .theme-btn {
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: transparent;
      color: var(--text-muted);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .theme-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 2px 10px var(--primary-glow);
    }

    .theme-btn:hover:not(.active) {
      background: var(--surface-hover);
      color: var(--text);
    }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 24px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .card:hover {
      border-color: var(--border);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12), 0 0 0 1px var(--primary-subtle);
      transform: translateY(-3px);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .step-num {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--gradient-1), var(--gradient-2));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      box-shadow: 0 4px 15px var(--primary-glow);
    }

    .card-title h2 {
      font-size: 18px;
      font-weight: 700;
    }

    .counter {
      background: linear-gradient(135deg, var(--gradient-1), var(--gradient-2));
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      color: white;
      box-shadow: 0 2px 10px var(--primary-glow);
    }

    /* Two Column Layout */
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    @media (max-width: 900px) {
      .two-column {
        grid-template-columns: 1fr;
      }
    }

    /* Textarea */
    .textarea {
      width: 100%;
      min-height: 180px;
      padding: 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      transition: all 0.3s ease;
    }

    .textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-subtle);
    }

    .textarea::placeholder {
      color: var(--text-muted);
    }

    /* JD Upload Section */
    .jd-upload-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-soft);
    }

    .jd-upload-zone {
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 12px;
    }

    .jd-upload-zone:hover {
      border-color: var(--primary);
      background: var(--primary-subtle);
    }

    .jd-file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: var(--bg);
      border: 1px solid var(--border-soft);
      border-radius: 10px;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }

    .jd-file-item:hover {
      border-color: var(--border);
    }

    /* Upload Zone */
    .upload-zone {
      border: 1px dashed var(--border);
      border-radius: 16px;
      padding: 50px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.4s ease;
      background: transparent;
    }

    .upload-zone:hover {
      border-color: var(--primary);
      background: var(--primary-subtle);
      transform: translateY(-2px);
    }

    .upload-zone.active {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 16px;
      display: inline-block;
      animation: gentleBounce 3s ease-in-out infinite;
    }

    @keyframes gentleBounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-6px);
      }
    }

    .upload-zone h3 {
      font-size: 16px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .upload-zone p {
      font-size: 14px;
      color: var(--text-muted);
    }

    /* File List */
    .file-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 16px;
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 18px;
      background: var(--bg);
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .file-item:hover {
      border-color: var(--border);
      background: var(--surface-hover);
      transform: translateX(3px);
    }

    .file-icon {
      font-size: 24px;
    }

    .file-info {
      flex: 1;
    }

    .file-name {
      font-size: 14px;
      font-weight: 600;
    }

    .file-remove {
      background: none;
      border: none;
      color: var(--text-soft);
      cursor: pointer;
      padding: 8px;
      font-size: 20px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .file-remove:hover {
      color: var(--danger);
      background: var(--danger-subtle);
    }

    /* Improve JD Button */
    .btn-improve {
      background: linear-gradient(135deg, var(--gradient-2), var(--gradient-3));
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.4s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 12px rgba(139, 92, 246, 0.25);
    }

    .btn-improve:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.35);
    }

    .btn-improve:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 16px 32px;
      border: none;
      border-radius: 14px;
      font-family: inherit;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--gradient-1), var(--gradient-2));
      color: white;
      box-shadow: 0 4px 20px var(--primary-glow);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 6px 28px var(--primary-glow);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
      padding: 12px 20px;
      font-size: 14px;
    }

    .btn-secondary:hover {
      background: var(--surface-hover);
    }

    .btn-reset {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      padding: 10px 18px;
      font-size: 13px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(239, 68, 68, 0.2);
    }

    .btn-reset:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
    }

    /* Action */
    .action {
      text-align: center;
      padding: 30px 0 50px;
    }

    .action-hint {
      margin-top: 14px;
      color: var(--text-muted);
      font-size: 14px;
    }

    /* Results */
    .results-section {
      padding-bottom: 60px;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .results-header h2 {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--gradient-1), var(--gradient-2), var(--gradient-3));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .result-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      margin-bottom: 20px;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    }

    .result-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 36px rgba(0, 0, 0, 0.1);
      border-color: var(--border);
    }

    .result-card.top {
      border-color: rgba(234, 179, 8, 0.3);
      background: linear-gradient(135deg, var(--warning-subtle), transparent);
    }

    .result-card.top:hover {
      border-color: rgba(234, 179, 8, 0.5);
    }

    .result-inner {
      display: flex;
      position: relative;
    }

    /* Rank Badge - Inline with name */
    .result-rank {
      display: inline-flex;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 80px;
      height: 38px;
      padding: 0 16px;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      border: 2px solid var(--border);
      border-radius: 24px;
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: 0.5px;
    }



    .result-card.top .rank-badge {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      border-color: #fbbf24;
      color: #000;
    }



    .rank-trophy {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      border-radius: 24px;
      border: 2px solid #000;
      box-shadow: 0 4px 16px rgba(251, 191, 36, 0.5);
    }

    .rank-trophy::after {
      content: 'Rank 1';
      font-size: 14px;
      font-weight: 700;
      color: #000;
      letter-spacing: 0.5px;
    }

    .result-body {
      flex: 1;
      padding: 12px 20px;
    }

    .result-top {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      align-items: flex-start;
    }

    .result-name-section {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .result-name-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .result-name {
      font-size: 18px;
      font-weight: 700;
    }

    .result-title {
      font-size: 13px;
      color: var(--text-soft);
    }

    .result-score {
      text-align: right;
    }

    .score-value {
      font-size: 36px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--gradient-1), var(--gradient-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .score-label {
      font-size: 12px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .result-summary {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.7;
      margin-bottom: 18px;
    }

    /* Fit Badge */
    .fit-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .fit-high {
      background: var(--success-subtle);
      color: var(--success);
    }

    .fit-medium {
      background: var(--warning-subtle);
      color: var(--warning);
    }

    .fit-low {
      background: var(--danger-subtle);
      color: var(--danger);
    }

    /* Candidate Checkbox - Sleek Compare Toggle */
    .candidate-checkbox-wrapper {
      position: absolute;
      bottom: 16px;
      right: 16px;
      z-index: 5;
    }

    .candidate-checkbox {
      /* Hide native checkbox */
      appearance: none;
      -webkit-appearance: none;
      width: 36px;
      height: 36px;
      border: 2px solid var(--border);
      border-radius: 50%;
      background: var(--surface);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .candidate-checkbox::before {
      content: '';
      width: 16px;
      height: 16px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238a8a9a' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M16 3h5v5'/%3E%3Cpath d='M8 3H3v5'/%3E%3Cpath d='M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3'/%3E%3Cpath d='m15 9 6-6'/%3E%3C/svg%3E");
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      transition: all 0.3s ease;
    }

    .candidate-checkbox:hover {
      border-color: var(--primary);
      background: var(--primary-subtle);
      transform: scale(1.1);
    }

    .candidate-checkbox:hover::before {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M16 3h5v5'/%3E%3Cpath d='M8 3H3v5'/%3E%3Cpath d='M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3'/%3E%3Cpath d='m15 9 6-6'/%3E%3C/svg%3E");
    }

    .candidate-checkbox:checked {
      border-color: var(--primary);
      background: var(--primary);
      box-shadow: 0 0 16px var(--primary-glow);
    }

    .candidate-checkbox:checked::before {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'/%3E%3C/svg%3E");
    }

    /* Skills */
    .skills-section {
      margin-top: 16px;
    }

    .skills-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-soft);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .skills-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .skill {
      padding: 5px 12px;
      background: var(--primary-subtle);
      color: var(--primary);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      border: 1px solid transparent;
    }

    .skill:hover {
      transform: translateY(-1px);
      background: rgba(99, 102, 241, 0.15);
      border-color: var(--primary-subtle);
    }

    .skill.missing {
      background: var(--danger-subtle);
      color: var(--danger);
    }

    .skill.missing:hover {
      background: rgba(239, 68, 68, 0.15);
    }

    .skill-tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 10;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .skill:hover .skill-tooltip {
      opacity: 1;
      visibility: visible;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 80px 0;
    }

    .spinner {
      width: 28px;
      height: 28px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 50px 0;
      color: var(--text-soft);
      font-size: 14px;
    }

    /* Hero */
    .hero {
      text-align: center;
      padding: 60px 0 50px;
    }

    .hero h2 {
      font-size: 48px;
      font-weight: 800;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--text) 0%, var(--gradient-1) 50%, var(--gradient-2) 100%);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradient-shift 6s ease infinite;
      transition: all 0.5s ease;
      cursor: default;
    }

    .hero h2:hover {
      transform: scale(1.02);
      filter: drop-shadow(0 0 25px var(--primary-glow));
      animation: gradient-shift 2s ease infinite;
    }

    @keyframes gradient-shift {
      0% {
        background-position: 0% center;
      }

      50% {
        background-position: 100% center;
      }

      100% {
        background-position: 0% center;
      }
    }

    .hero p {
      color: var(--text-muted);
      font-size: 18px;
      max-width: 600px;
      margin: 0 auto;
    }

    /* Compare Button */
    .compare-floating {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
      box-shadow: 0 4px 24px var(--primary-glow);
      transition: all 0.4s ease;
    }

    .compare-floating:hover:not(:disabled) {
      box-shadow: 0 6px 32px var(--primary-glow);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal-content {
      background: var(--surface);
      padding: 32px;
      border-radius: 20px;
      max-width: 720px;
      width: 90%;
      max-height: 88vh;
      overflow-y: auto;
      border: 1px solid var(--border);
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.4);
      animation: slideUp 0.35s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 28px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-soft);
    }

    .modal-header h2 {
      font-size: 22px;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 10px;
      transition: all 0.2s ease;
      line-height: 1;
    }

    .modal-close:hover {
      background: var(--bg);
      color: var(--text);
    }

    /* Refined Modal Sections */
    .modal-section {
      margin-bottom: 24px;
      padding: 20px;
      background: var(--bg);
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      transition: all 0.3s ease;
    }

    .modal-section:hover {
      border-color: var(--border);
    }

    .modal-section h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
    }

    .modal-section.strengths h3 {
      color: var(--success);
    }

    .modal-section.improvements h3 {
      color: var(--warning);
    }

    .modal-section.suggestions h3 {
      color: var(--primary);
    }

    .modal-section ul {
      margin: 0;
      padding-left: 20px;
      color: var(--text-muted);
    }

    .modal-section li {
      margin-bottom: 8px;
      line-height: 1.6;
      font-size: 14px;
    }

    .modal-section li:last-child {
      margin-bottom: 0;
    }

    .modal-section.improved {
      background: transparent;
      border: none;
      padding: 0;
      margin-top: 28px;
    }

    .modal-section.improved h3 {
      margin-bottom: 12px;
      color: var(--text);
    }

    /* Comparison Modal */
    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    @media (max-width: 600px) {
      .comparison-grid {
        grid-template-columns: 1fr;
      }
    }

    .comparison-column {
      padding: 20px;
      background: var(--bg);
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      transition: all 0.3s ease;
    }

    .comparison-column:hover {
      border-color: var(--border);
    }

    .comparison-column h4 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--primary);
    }

    .comparison-column p {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .comparison-recommendation {
      padding: 20px;
      background: var(--primary-subtle);
      border-radius: 14px;
      border: 1px solid rgba(99, 102, 241, 0.15);
    }

    .comparison-recommendation h5 {
      font-size: 13px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .comparison-recommendation p {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.7;
      margin: 0;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;
    const API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? "http://127.0.0.1:8000"
      : "/api";

    // Custom SVG Icons - Sleek & Professional
    const Icons = {
      // Analytics/Chart icon
      Chart: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M3 3v18h18" />
          <path d="M18 17V9" />
          <path d="M13 17V5" />
          <path d="M8 17v-3" />
        </svg>
      ),
      // Folder/Upload icon
      Folder: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
          <line x1="12" y1="11" x2="12" y2="17" />
          <polyline points="9 14 12 11 15 14" />
        </svg>
      ),
      // Document icon
      Document: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
          <polyline points="14 2 14 8 20 8" />
          <line x1="16" y1="13" x2="8" y2="13" />
          <line x1="16" y1="17" x2="8" y2="17" />
          <polyline points="10 9 9 9 8 9" />
        </svg>
      ),
      // Trophy/Crown icon
      Trophy: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
          <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
          <path d="M4 22h16" />
          <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" />
          <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" />
          <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
        </svg>
      ),
      // Sparkles/Magic icon
      Sparkles: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
          <path d="M5 3v4" />
          <path d="M19 17v4" />
          <path d="M3 5h4" />
          <path d="M17 19h4" />
        </svg>
      ),
      // Lightning/Bolt icon
      Bolt: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
        </svg>
      ),
      // Compare/Sync icon
      Compare: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M16 3h5v5" />
          <path d="M8 3H3v5" />
          <path d="M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3" />
          <path d="m15 9 6-6" />
        </svg>
      ),
      // Checkmark/Success icon
      Check: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
          <polyline points="22 4 12 14.01 9 11.01" />
        </svg>
      ),
      // Warning/Alert icon
      Warning: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
          <line x1="12" y1="9" x2="12" y2="13" />
          <line x1="12" y1="17" x2="12.01" y2="17" />
        </svg>
      ),
      // X/Error icon
      X: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
          <circle cx="12" cy="12" r="10" />
          <line x1="15" y1="9" x2="9" y2="15" />
          <line x1="9" y1="9" x2="15" y2="15" />
        </svg>
      ),
      // Lightbulb/Idea icon
      Lightbulb: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5" />
          <path d="M9 18h6" />
          <path d="M10 22h4" />
        </svg>
      ),
      // Brain/AI icon
      Brain: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z" />
          <path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z" />
        </svg>
      ),
      // Reset/Refresh icon
      Reset: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
          <path d="M21 3v5h-5" />
          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
          <path d="M8 16H3v5" />
        </svg>
      ),
      // User/Person icon
      User: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
          <circle cx="12" cy="7" r="4" />
        </svg>
      ),
      // Star/Rank icon
      Star: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill={color} stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
        </svg>
      ),
      // Skills/Code icon
      Code: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="16 18 22 12 16 6" />
          <polyline points="8 6 2 12 8 18" />
        </svg>
      ),
      // Target/Match icon
      Target: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <circle cx="12" cy="12" r="10" />
          <circle cx="12" cy="12" r="6" />
          <circle cx="12" cy="12" r="2" />
        </svg>
      ),
      // History/Time icon
      History: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
        </svg>
      ),
      // Users/Group icon
      Users: ({ size = 20, color = "currentColor" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
          <circle cx="9" cy="7" r="4" />
          <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
          <path d="M16 3.13a4 4 0 0 1 0 7.75" />
        </svg>
      )
    };

    function App() {
      const [jd, setJd] = useState('');
      const [jdFiles, setJdFiles] = useState([]);
      const [files, setFiles] = useState([]);
      const [loading, setLoading] = useState(false);
      const [results, setResults] = useState(null);
      const [dragActive, setDragActive] = useState(false);
      const [theme, setTheme] = useState('dark');

      const [jdAnalysis, setJdAnalysis] = useState(null);
      const [improvingJd, setImprovingJd] = useState(false);
      const [selectedCandidates, setSelectedCandidates] = useState([]);
      const [comparing, setComparing] = useState(false);
      const [comparisonResult, setComparisonResult] = useState(null);
      const [showJdModal, setShowJdModal] = useState(false);
      const [showCompareModal, setShowCompareModal] = useState(false);
      const [showHistoryModal, setShowHistoryModal] = useState(false);
      const [historyList, setHistoryList] = useState([]);
      const [loadingHistory, setLoadingHistory] = useState(false);

      const inputRef = useRef(null);
      const jdInputRef = useRef(null);

      useEffect(() => {
        const savedTheme = sessionStorage.getItem('theme') || 'dark';
        setTheme(savedTheme);
        document.documentElement.setAttribute('data-theme', savedTheme);
      }, []);

      const toggleTheme = (newTheme) => {
        setTheme(newTheme);
        sessionStorage.setItem('theme', newTheme);
        document.documentElement.setAttribute('data-theme', newTheme);
      };

      useEffect(() => {
        const initializeApp = async () => {
          try {
            // Reset backend state on page load for fresh start
            await fetch(`${API}/reset`, { method: "POST" });
          } catch (e) {
            console.error("Failed to reset on load:", e);
          }
        };
        initializeApp();
      }, []);

      const uploadFile = async (fileList) => {
        const arr = Array.from(fileList);
        if (!arr.length) return;

        const form = new FormData();
        arr.forEach(f => form.append("files", f));

        try {
          const res = await fetch(`${API}/upload-resumes`, { method: "POST", body: form });
          const data = await res.json();
          if (data.uploaded?.length) {
            setFiles(prev => [...prev, ...data.uploaded]);
          }
          if (data.errors?.length) alert(data.errors.join("\n"));
        } catch (e) {
          alert("Upload failed: " + e.message);
        }
      };

      const handleJdFileUpload = async (fileList) => {
        const arr = Array.from(fileList);
        for (const file of arr) {
          // For txt files, read directly
          if (file.name.toLowerCase().endsWith('.txt')) {
            const reader = new FileReader();
            reader.onload = (e) => {
              setJdFiles(prev => [...prev, { name: file.name, id: Date.now() + Math.random() }]);
              setJd(prev => prev + (prev ? '\n\n' : '') + e.target.result);
            };
            reader.readAsText(file);
          } else {
            // For PDF, DOCX, etc. - use backend to extract text
            try {
              const form = new FormData();
              form.append("file", file);

              const res = await fetch(`${API}/upload-jd-file`, {
                method: "POST",
                body: form
              });

              if (res.ok) {
                const data = await res.json();
                if (data.extracted_text) {
                  setJdFiles(prev => [...prev, { name: file.name, id: Date.now() + Math.random() }]);
                  setJd(prev => prev + (prev ? '\n\n' : '') + data.extracted_text);
                }
              } else {
                const err = await res.json().catch(() => ({}));
                alert(`Failed to extract text from ${file.name}: ${err.detail || 'Unknown error'}`);
              }
            } catch (e) {
              console.error('JD file upload error:', e);
              alert(`Failed to upload ${file.name}: ${e.message}`);
            }
          }
        }
      };

      const removeJdFile = (id) => {
        setJdFiles(prev => prev.filter(f => f.id !== id));
      };

      const removeFile = async (id) => {
        await fetch(`${API}/resumes/${id}`, { method: "DELETE" });
        setFiles(prev => prev.filter(f => f.id !== id));
      };

      const analyze = async () => {
        // Validate: need JD (either text in textarea OR uploaded files) and at least one resume
        const hasJdText = jd && jd.trim().length >= 10;
        const hasJdFiles = jdFiles.length > 0;

        if (!hasJdText && !hasJdFiles) {
          alert("Please provide a Job Description. You can either paste text or upload a PDF/Word file.");
          return;
        }
        if (files.length === 0) {
          alert("Please upload at least one resume to analyze.");
          return;
        }

        setLoading(true);
        setResults(null);
        setSelectedCandidates([]);

        try {
          // 1. Upload JD Text if we have text in the textarea
          // (If JD was uploaded as file, the backend already has the text from /upload-jd-file)
          if (hasJdText) {
            console.log("Step 1: Uploading JD Text...");
            const jdRes = await fetch(`${API}/upload-jd-text`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ text: jd })
            });
            if (!jdRes.ok) throw new Error(`JD Upload failed: ${jdRes.status} ${jdRes.statusText}`);
          } else {
            console.log("Step 1: JD already uploaded via file, skipping text upload...");
          }

          // 2. Trigger Analysis
          console.log("Step 2: Triggering Analysis...");
          const analyzeRes = await fetch(`${API}/analyze`, { method: "POST" });

          if (!analyzeRes.ok) {
            const errText = await analyzeRes.text(); // Get server error message if any
            throw new Error(`Analysis failed: ${analyzeRes.status} - ${errText || analyzeRes.statusText}`);
          }

          // 3. Fetch Results
          console.log("Step 3: Fetching Results...");
          const res = await fetch(`${API}/results?use_ai=false`);
          if (!res.ok) throw new Error(`Fetch Results failed: ${res.status}`);

          const data = await res.json();
          setResults(data.results);

          setTimeout(() => {
            document.getElementById("results")?.scrollIntoView({ behavior: "smooth" });
          }, 100);
        } catch (e) {
          console.error("Analysis Error Details:", e);
          alert("Analysis Error: " + e.message + "\n\nCheck console for more details.");
        } finally {
          setLoading(false);
        }
      };

      const improveJd = async () => {
        if (jd.length < 50) return alert("JD too short to analyze");
        setImprovingJd(true);
        try {
          const res = await fetch(`${API}/improve-jd`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: jd })
          });

          if (!res.ok) {
            throw new Error(`Server error: ${res.status}`);
          }

          const data = await res.json();

          if (!data.analysis || !data.analysis.improved_version) {
            throw new Error("AI did not return valid analysis. Make sure Ollama is running (ollama serve)");
          }

          setJdAnalysis(data.analysis);
          setShowJdModal(true);
        } catch (e) {
          alert(`AI Improvement Failed\n\n${e.message}\n\nEnsure your API Key is valid or the backend is running.`);
          console.error('JD Improvement error:', e);
        } finally {
          setImprovingJd(false);
        }
      };

      const toggleCandidate = (id) => {
        setSelectedCandidates(prev => {
          if (prev.includes(id)) return prev.filter(c => c !== id);
          if (prev.length >= 2) {
            alert("Select exactly 2 candidates to compare.");
            return prev;
          }
          return [...prev, id];
        });
      };

      const compareCandidates = async () => {
        if (selectedCandidates.length !== 2) return;
        setComparing(true);
        try {
          const res = await fetch(`${API}/compare`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ candidate_ids: selectedCandidates })
          });

          if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            throw new Error(errorData.detail || `Server error: ${res.status}`);
          }

          const data = await res.json();
          if (data.success && data.comparison) {
            setComparisonResult(data.comparison);
            setShowCompareModal(true);
          } else {
            throw new Error("Invalid comparison response");
          }
        } catch (e) {
          alert(`Comparison Failed\n\n${e.message}\n\nMake sure analysis was completed first.`);
          console.error('Comparison error:', e);
        } finally {
          setComparing(false);
        }
      };

      const reset = async () => {
        try {
          // Call backend reset endpoint to clear uploads and state
          await fetch(`${API}/reset`, { method: "POST" });
        } catch (e) {
          console.error('Backend reset failed:', e);
          // Continue with frontend reset even if backend fails
        }

        // Clear frontend state
        setFiles([]);
        setResults(null);
        setJd('');
        setJdFiles([]);
        setJdAnalysis(null);
        setComparisonResult(null);
        setSelectedCandidates([]);
        setSelectedCandidates([]);
      };

      // History Functions
      const fetchHistory = async () => {
        setLoadingHistory(true);
        setShowHistoryModal(true);
        try {
          const res = await fetch(`${API}/history`);
          if (res.ok) {
            const data = await res.json();
            setHistoryList(data);
          }
        } catch (e) {
          console.error("Failed to fetch history:", e);
        } finally {
          setLoadingHistory(false);
        }
      };

      const loadHistoryItem = async (id) => {
        try {
          setLoading(true);
          setShowHistoryModal(false);
          const res = await fetch(`${API}/history/${id}`);
          if (res.ok) {
            const data = await res.json();
            // Populate state
            setJd(data.jd_preview || "Loaded from history"); // We only stored preview, user might want full text but for now this is ok
            // Or if we stored full jd text in history detail:
            // Note: in backend I stored db.collection('history').add(doc_data) where doc_data has full_results.
            // But jd_preview is short. I probably should have saved full JD.
            // For now, let's just show results.

            setResults(data.full_results);
            // setFiles from results?? No, files are gone. Only results remain.
            // We can fake files list if needed, but results are what matters.
            setResults(data.full_results);

            // Scroll to results
            setTimeout(() => {
              document.getElementById('results-section')?.scrollIntoView({ behavior: 'smooth' });
            }, 500);
          }
        } catch (e) {
          alert("Failed to load history item");
        } finally {
          setLoading(false);
        }
      };

      // State for report generation
      const [generatingReport, setGeneratingReport] = React.useState(false);
      const [aiReport, setAiReport] = React.useState(null);
      const [showReportModal, setShowReportModal] = React.useState(false);

      // PDF Export Function - Now uses AI to generate the report content
      const exportToPdf = async () => {
        if (!results || results.length === 0) {
          alert("No results to export. Please run analysis first.");
          return;
        }

        setGeneratingReport(true);

        try {
          // Call AI to generate the full report
          const res = await fetch(`${API}/generate-report`, {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });

          if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            throw new Error(errorData.detail || `Server error: ${res.status}`);
          }

          const data = await res.json();

          if (data.success && data.report) {
            setAiReport(data.report);
            setShowReportModal(true);
          } else {
            throw new Error("Failed to generate report");
          }
        } catch (e) {
          alert(`Report Generation Failed\n\n${e.message}`);
          console.error('Report error:', e);
        } finally {
          setGeneratingReport(false);
        }
      };

      // Download the AI report as PDF
      const downloadReportPdf = () => {
        if (!aiReport) return;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 15;
        let yPos = 20;

        // Helper to add new page if needed
        const checkPageBreak = (neededSpace = 20) => {
          if (yPos + neededSpace > 280) {
            doc.addPage();
            yPos = 20;
          }
        };

        // Title
        doc.setFontSize(20);
        doc.setTextColor(99, 102, 241);
        doc.text("AI Resume Screening Report", margin, yPos);
        yPos += 8;

        // Date
        doc.setFontSize(9);
        doc.setTextColor(120, 120, 120);
        doc.text(`Generated by Gemini AI on ${new Date().toLocaleString()}`, margin, yPos);
        yPos += 10;

        // Divider
        doc.setDrawColor(200, 200, 200);
        doc.line(margin, yPos, pageWidth - margin, yPos);
        yPos += 12;

        // Parse and render the AI report
        doc.setFontSize(10);
        doc.setTextColor(40, 40, 40);

        const lines = aiReport.split('\n');

        lines.forEach(line => {
          checkPageBreak(8);

          // Handle markdown-style headers
          if (line.startsWith('# ')) {
            doc.setFontSize(16);
            doc.setTextColor(99, 102, 241);
            doc.setFont(undefined, 'bold');
            doc.text(line.replace('# ', ''), margin, yPos);
            yPos += 10;
          } else if (line.startsWith('## ')) {
            doc.setFontSize(14);
            doc.setTextColor(80, 80, 80);
            doc.setFont(undefined, 'bold');
            doc.text(line.replace('## ', ''), margin, yPos);
            yPos += 8;
          } else if (line.startsWith('### ')) {
            doc.setFontSize(12);
            doc.setTextColor(60, 60, 60);
            doc.setFont(undefined, 'bold');
            doc.text(line.replace('### ', ''), margin, yPos);
            yPos += 7;
          } else if (line.startsWith('**') && line.endsWith('**')) {
            doc.setFontSize(11);
            doc.setTextColor(50, 50, 50);
            doc.setFont(undefined, 'bold');
            doc.text(line.replace(/\*\*/g, ''), margin, yPos);
            yPos += 6;
          } else if (line.trim() === '---') {
            doc.setDrawColor(220, 220, 220);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 6;
          } else if (line.trim()) {
            doc.setFontSize(10);
            doc.setTextColor(60, 60, 60);
            doc.setFont(undefined, 'normal');
            // Handle bold text within lines
            const cleanLine = line.replace(/\*\*/g, '');
            const wrappedLines = doc.splitTextToSize(cleanLine, pageWidth - 2 * margin);
            wrappedLines.forEach(wl => {
              checkPageBreak(5);
              doc.text(wl, margin, yPos);
              yPos += 5;
            });
          } else {
            yPos += 3; // Empty line spacing
          }
        });

        // Footer
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.setTextColor(150, 150, 150);
          doc.text(`Page ${i} of ${pageCount} | Generated by ResumeAI Pro with Gemini AI`, pageWidth / 2, 290, { align: 'center' });
        }

        doc.save(`AI_Hiring_Report_${new Date().toISOString().split('T')[0]}.pdf`);
      };

      return (
        <>
          {/* Animated Background */}
          <div className="animated-bg">
            <div className="wave"></div>
            <div className="wave"></div>
            <div className="wave"></div>
            <div className="bubble"></div>
            <div className="bubble"></div>
            <div className="bubble"></div>
            <div className="bubble"></div>
            <div className="bubble"></div>
            <div className="bubble"></div>
            <div className="bubble"></div>
            <div className="bubble"></div>
            <div className="bubble"></div>
            <div className="bubble"></div>
            <div className="bubble"></div>
            <div className="bubble"></div>
          </div>

          <header className="header">
            <div className="container">
              <div className="header-inner">
                <div className="logo">
                  <div className="logo-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                      <circle cx="12" cy="8" r="4" />
                      <path d="M6 20c0-4 3-6 6-6s6 2 6 6" />
                    </svg>
                  </div>
                  <h1>Resume<span>AI</span> Pro</h1>
                </div>

                <div className="header-controls">
                  <div id="user-info" style={{ fontSize: '14px', marginRight: '15px', color: 'var(--text-muted)', display: 'none' }}>
                    <span id="user-email"></span>
                  </div>
                  <div className="theme-controls">
                    <button
                      className={`theme-btn ${theme === 'light' ? 'active' : ''}`}
                      onClick={() => toggleTheme('light')}
                    >
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="5" /><line x1="12" y1="1" x2="12" y2="3" /><line x1="12" y1="21" x2="12" y2="23" /><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /><line x1="1" y1="12" x2="3" y2="12" /><line x1="21" y1="12" x2="23" y2="12" /><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" /><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" /></svg>
                      Light
                    </button>
                    <button
                      className={`theme-btn ${theme === 'dark' ? 'active' : ''}`}
                      onClick={() => toggleTheme('dark')}
                    >
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" /></svg>
                      Dark
                    </button>
                  </div>
                  <button
                    className="theme-btn"
                    title="Sign Out"
                    onClick={() => window.logout()}
                    style={{ marginLeft: '8px', color: 'var(--danger)' }}
                  >
                    <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                  </button>
                  <button className="theme-btn" onClick={fetchHistory} title="View History">
                    <Icons.History size={16} /> History
                  </button>
                  <button className="btn btn-reset" onClick={reset}>
                    <Icons.Reset size={16} /> Reset
                  </button>
                </div>
              </div>
            </div>
          </header>

          <main className="container">
            <section className="hero">
              <h2>AI-Powered Resume Screening</h2>
              <p>Upload resumes and get intelligent, personalized candidate analysis in seconds.</p>
            </section>

            {/* Two Column Layout */}
            <div className="two-column">
              {/* Left: Job Description */}
              <div className="card">
                <div className="card-header">
                  <div className="card-title">
                    <div className="step-num">1</div>
                    <h2>Job Description</h2>
                  </div>
                  {jd.length > 50 && (
                    <button className="btn-improve" onClick={improveJd} disabled={improvingJd}>
                      {improvingJd ? (
                        <>
                          <div className="spinner" style={{ width: 16, height: 16, borderWidth: 2 }}></div>
                          Analyzing...
                        </>
                      ) : (
                        <><Icons.Sparkles size={16} /> Improve JD with AI</>
                      )}
                    </button>
                  )}
                </div>

                <textarea
                  className="textarea"
                  placeholder="Paste the job description here...&#10;&#10;Example: We're looking for a Full-Stack Developer with 3+ years experience in React, Node.js, Python, AWS..."
                  value={jd}
                  onChange={(e) => setJd(e.target.value)}
                />

                <div className="jd-upload-section">
                  <div className="skills-label">Or upload JD file</div>

                  {jdFiles.map(f => (
                    <div key={f.id} className="jd-file-item">
                      <Icons.Document size={18} color="var(--primary)" />
                      <div style={{ flex: 1 }}>
                        <div className="file-name">{f.name}</div>
                      </div>
                      <button className="file-remove" onClick={() => removeJdFile(f.id)}></button>
                    </div>
                  ))}

                  <div
                    className="jd-upload-zone"
                    onClick={() => jdInputRef.current?.click()}
                  >
                    <div><Icons.Document size={18} /> Click to upload JD (PDF, Word, Excel, TXT)</div>
                    <input
                      ref={jdInputRef}
                      type="file"
                      accept=".pdf,.doc,.docx,.xls,.xlsx,.txt"
                      style={{ display: 'none' }}
                      onChange={(e) => { handleJdFileUpload(e.target.files); e.target.value = ''; }}
                    />
                  </div>
                </div>

                {(jd.length > 50 || jdFiles.length > 0) && (
                  <div style={{ marginTop: '12px', color: 'var(--success)', fontSize: '13px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                     JD ready {jd.length > 0 ? `(${jd.length} characters)` : `(${jdFiles.length} file${jdFiles.length > 1 ? 's' : ''} uploaded)`}
                  </div>
                )}
              </div>

              {/* Right: Resume Upload */}
              <div className="card">
                <div className="card-header">
                  <div className="card-title">
                    <div className="step-num">2</div>
                    <h2>Upload Resumes</h2>
                  </div>
                  <div className="counter">{files.length} Uploaded</div>
                </div>

                <div className="file-list">
                  {files.map(f => (
                    <div key={f.id} className="file-item">
                      <span className="file-icon"><Icons.Document size={18} color="var(--primary)" /></span>
                      <div className="file-info">
                        <div className="file-name">{f.name}</div>
                      </div>
                      <button className="file-remove" onClick={() => removeFile(f.id)}></button>
                    </div>
                  ))}
                </div>

                <div
                  className={`upload-zone ${dragActive ? 'active' : ''}`}
                  onDragOver={(e) => { e.preventDefault(); setDragActive(true); }}
                  onDragLeave={() => setDragActive(false)}
                  onDrop={(e) => { e.preventDefault(); setDragActive(false); uploadFile(e.dataTransfer.files); }}
                  onClick={() => inputRef.current?.click()}
                >
                  <div className="upload-icon"><Icons.Folder size={32} color="var(--primary)" /></div>
                  <h3>Drop files here or click to browse</h3>
                  <p>PDF, DOCX, or TXT files</p>
                  <input
                    ref={inputRef}
                    type="file"
                    multiple
                    accept=".pdf,.docx,.txt"
                    style={{ display: 'none' }}
                    onChange={(e) => { uploadFile(e.target.files); e.target.value = ''; }}
                  />
                </div>
              </div>
            </div>

            {/* Analyze Button */}
            <div className="action">
              <button
                className="btn btn-primary"
                onClick={analyze}
                disabled={!jd || files.length === 0 || loading}
              >
                {loading ? (
                  <>
                    <div className="spinner" style={{ width: 20, height: 20, borderWidth: 2 }}></div>
                    Analyzing with AI...
                  </>
                ) : (
                  <><Icons.Bolt size={18} /> Calculate Match Scores</>
                )}
              </button>
              {!loading && files.length === 0 && (
                <p className="action-hint">Upload at least 1 resume to continue</p>
              )}
            </div>

            {/* Results */}
            {results && (
              <section id="results" className="results-section">
                <div className="results-header">
                  <h2><Icons.Chart size={24} color="var(--primary)" /> Analysis Results</h2>
                  <span style={{ color: 'var(--text-muted)', fontSize: 14 }}>
                    {results.length} candidates ranked
                  </span>
                </div>

                {results.map((r, i) => (
                  <div key={r.id || i} className={`result-card ${i === 0 ? 'top' : ''}`}>
                    <div className="result-inner">
                      {/* Checkbox positioned bottom-right */}
                      <div className="candidate-checkbox-wrapper">
                        <input
                          type="checkbox"
                          className="candidate-checkbox"
                          checked={selectedCandidates.includes(r.id)}
                          onChange={() => toggleCandidate(r.id)}
                          title="Select for comparison"
                        />
                      </div>

                      <div className="result-body">
                        <div className="result-top">
                          <div className="result-name-section">
                            <div className="result-name-row">
                              {/* Rank Badge - Inline */}
                              <div className="result-rank">
                                {i === 0 ? (
                                  <span className="rank-trophy">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="#fbbf24" stroke="#000" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                      <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
                                      <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
                                      <path d="M4 22h16" />
                                      <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" />
                                      <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" />
                                      <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
                                    </svg>
                                  </span>
                                ) : (
                                  <span className="rank-badge">Rank {r.rank}</span>
                                )}
                              </div>
                              <span className="result-name">{r.resume_name}</span>
                              <span className={`fit-badge fit-${r.fit?.toLowerCase()}`}>
                                {r.fit}
                              </span>
                            </div>
                          </div>
                          <div className="result-score">
                            <div className="score-value">{r.match_score}%</div>
                            <div className="score-label">Match Score</div>
                          </div>
                        </div>

                        <div className="result-summary">{r.summary}</div>

                        <div className="skills-section">
                          <div className="skills-label">Skills</div>
                          <div className="skills-row">
                            {r.matched_skills?.slice(0, 8).map(s => (
                              <span key={s} className="skill">
                                {s}
                                <span className="skill-tooltip"><Icons.Check size={12} /> Matched</span>
                              </span>
                            ))}
                            {r.missing_skills?.slice(0, 4).map(s => (
                              <span key={s} className="skill missing">
                                {s}
                                <span className="skill-tooltip"><Icons.Warning size={12} /> Gap area</span>
                              </span>
                            ))}
                          </div>
                        </div>

                        {/* AI Explanation Section */}
                        {r.explanation && (
                          <div className="explanation-section" style={{ marginTop: '16px', padding: '12px', background: 'var(--bg-secondary)', borderRadius: '8px', border: '1px solid var(--border-color)' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px' }}>
                              <Icons.Lightbulb size={18} color="var(--primary)" />
                              <div style={{ fontWeight: 600, color: 'var(--text-primary)', fontSize: '14px' }}>AI Match Insight</div>
                            </div>

                            {/* Executive Summary */}
                            <p style={{ fontSize: '14px', lineHeight: '1.6', margin: '0 0 16px 0', color: 'var(--text-secondary)' }}>
                              {r.explanation.summary}
                            </p>

                            {/* AI Verdict Badge */}
                            {r.explanation.verdict && (
                              <div style={{
                                marginBottom: '16px',
                                padding: '8px 12px',
                                background: r.explanation.verdict.includes('STRONG') ? 'var(--success-subtle)' :
                                  r.explanation.verdict.includes('WORTH') ? 'var(--primary-subtle)' :
                                    r.explanation.verdict.includes('PASS') ? 'var(--danger-subtle)' : 'var(--warning-subtle)',
                                borderRadius: '6px',
                                fontSize: '13px',
                                fontWeight: 600,
                                color: r.explanation.verdict.includes('STRONG') ? 'var(--success)' :
                                  r.explanation.verdict.includes('WORTH') ? 'var(--primary)' :
                                    r.explanation.verdict.includes('PASS') ? 'var(--danger)' : 'var(--warning)'
                              }}>
                                <Icons.Brain size={14} /> {r.explanation.verdict}
                              </div>
                            )}

                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                              {/* Strengths */}
                              {r.explanation.strengths?.length > 0 && (
                                <div style={{ background: 'rgba(34, 197, 94, 0.05)', padding: '12px', borderRadius: '8px', border: '1px solid rgba(34, 197, 94, 0.15)' }}>
                                  <div style={{ fontSize: '11px', fontWeight: 700, color: 'var(--success)', textTransform: 'uppercase', marginBottom: '8px', letterSpacing: '0.5px' }}>
                                    <Icons.Check size={12} /> Strengths
                                  </div>
                                  <ul style={{ margin: 0, paddingLeft: '14px', fontSize: '12px', color: 'var(--text-secondary)', lineHeight: '1.5' }}>
                                    {r.explanation.strengths.slice(0, 3).map((s, i) => (
                                      <li key={i} style={{ marginBottom: '6px' }}>{s}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}

                              {/* Concerns */}
                              {r.explanation.concerns?.length > 0 && (
                                <div style={{ background: 'rgba(234, 179, 8, 0.05)', padding: '12px', borderRadius: '8px', border: '1px solid rgba(234, 179, 8, 0.15)' }}>
                                  <div style={{ fontSize: '11px', fontWeight: 700, color: 'var(--warning)', textTransform: 'uppercase', marginBottom: '8px', letterSpacing: '0.5px' }}>
                                    <Icons.Warning size={12} /> Concerns
                                  </div>
                                  <ul style={{ margin: 0, paddingLeft: '14px', fontSize: '12px', color: 'var(--text-secondary)', lineHeight: '1.5' }}>
                                    {r.explanation.concerns.slice(0, 2).map((c, i) => (
                                      <li key={i} style={{ marginBottom: '6px' }}>{c}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                            </div>

                            {/* Interview Tips */}
                            {r.explanation.tips?.length > 0 && (
                              <div style={{ marginTop: '12px', background: 'rgba(99, 102, 241, 0.05)', padding: '12px', borderRadius: '8px', border: '1px solid rgba(99, 102, 241, 0.15)' }}>
                                <div style={{ fontSize: '11px', fontWeight: 700, color: 'var(--primary)', textTransform: 'uppercase', marginBottom: '8px', letterSpacing: '0.5px' }}>
                                  <Icons.Lightbulb size={12} /> Interview Tips
                                </div>
                                <ul style={{ margin: 0, paddingLeft: '14px', fontSize: '12px', color: 'var(--text-secondary)', lineHeight: '1.5' }}>
                                  {r.explanation.tips.slice(0, 3).map((t, i) => (
                                    <li key={i} style={{ marginBottom: '4px' }}>{t}</li>
                                  ))}
                                </ul>
                              </div>
                            )}
                          </div>
                        )}

                        {/* Hire Recommendation Badge */}
                        <div style={{
                          marginTop: '16px',
                          padding: '12px 16px',
                          borderRadius: '8px',
                          background: r.match_score >= 75 ? 'var(--success-subtle)' : r.match_score >= 45 ? 'var(--warning-subtle)' : 'var(--danger-subtle)',
                          border: `1px solid ${r.match_score >= 75 ? 'var(--success)' : r.match_score >= 45 ? 'var(--warning)' : 'var(--danger)'}`,
                          display: 'flex',
                          alignItems: 'center',
                          gap: '10px'
                        }}>
                          <span style={{ display: 'flex' }}>
                            {r.match_score >= 75 ? <Icons.Check size={22} color="var(--success)" /> : r.match_score >= 45 ? <Icons.Warning size={22} color="var(--warning)" /> : <Icons.X size={22} color="var(--danger)" />}
                          </span>
                          <div>
                            <div style={{
                              fontWeight: 700,
                              fontSize: '14px',
                              color: r.match_score >= 75 ? 'var(--success)' : r.match_score >= 45 ? 'var(--warning)' : 'var(--danger)'
                            }}>
                              {r.match_score >= 75 ? 'STRONG HIRE RECOMMENDATION' :
                                r.match_score >= 60 ? 'GOOD MATCH' :
                                  r.match_score >= 45 ? 'POTENTIAL MATCH' :
                                    'NOT RECOMMENDED'}
                            </div>
                            <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '2px' }}>
                              {r.match_score >= 75 ? 'This candidate strongly matches the job requirements.' :
                                r.match_score >= 45 ? 'Candidate shows potential. Review skill gaps.' :
                                  'Significant skill gaps detected. Consider other candidates.'}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </section>
            )}

            {/* JD Analysis Modal - Refined */}
            {showJdModal && jdAnalysis && (
              <div className="modal-overlay" onClick={() => setShowJdModal(false)}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                  <div className="modal-header">
                    <h2>JD Analysis</h2>
                    <button className="modal-close" onClick={() => setShowJdModal(false)}></button>
                  </div>

                  <div className="modal-section strengths">
                    <h3><Icons.Check size={18} color="var(--success)" /> Strengths</h3>
                    <ul>
                      {jdAnalysis.strengths?.map((s, i) => <li key={i}>{s}</li>)}
                    </ul>
                  </div>

                  <div className="modal-section improvements">
                    <h3><Icons.Lightbulb size={18} color="var(--warning)" /> Potential Improvements</h3>
                    <ul>
                      {jdAnalysis.weaknesses?.map((w, i) => <li key={i}>{w}</li>)}
                    </ul>
                  </div>

                  <div className="modal-section suggestions">
                    <h3><Icons.Sparkles size={18} color="var(--primary)" /> Suggestions</h3>
                    <ul>
                      {jdAnalysis.suggestions?.map((s, i) => <li key={i}>{s}</li>)}
                    </ul>
                  </div>

                  <div className="modal-section improved">
                    <h3><Icons.Document size={18} /> Improved Version</h3>
                    <textarea
                      className="textarea"
                      style={{ minHeight: '180px' }}
                      value={jdAnalysis.improved_version}
                      readOnly
                    />
                  </div>

                  <button
                    className="btn btn-primary"
                    style={{ width: '100%', marginTop: '20px' }}
                    onClick={() => {
                      setJd(jdAnalysis.improved_version);
                      setShowJdModal(false);
                    }}
                  >
                    Use Improved Description
                  </button>
                </div>
              </div>
            )}

            {/* History Modal */}
            {showHistoryModal && (
              <div className="modal-overlay" onClick={() => setShowHistoryModal(false)}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '800px' }}>
                  <div className="modal-header">
                    <h2><Icons.History size={24} /> Analysis History</h2>
                    <button className="modal-close" onClick={() => setShowHistoryModal(false)}></button>
                  </div>

                  {loadingHistory ? (
                    <div style={{ textAlign: 'center', padding: '40px' }}>
                      <div className="spinner" style={{ width: 32, height: 32, borderWidth: 3 }}></div>
                      <p style={{ marginTop: '16px', color: 'var(--text-muted)' }}>Loading history...</p>
                    </div>
                  ) : historyList.length === 0 ? (
                    <div style={{ textAlign: 'center', padding: '40px', color: 'var(--text-muted)' }}>
                      <Icons.History size={48} style={{ opacity: 0.2, marginBottom: '16px' }} />
                      <p>No analysis history found.</p>
                    </div>
                  ) : (
                    <div className="file-list" style={{ maxHeight: '500px' }}>
                      {historyList.map(item => (
                        <div key={item.id} className="file-item" style={{ cursor: 'pointer' }} onClick={() => loadHistoryItem(item.id)}>
                          <div className="file-icon">
                            {item.candidate_count > 0 ? (
                              <Icons.Chart size={24} color="var(--primary)" />
                            ) : (
                              <Icons.Document size={24} color="var(--text-muted)" />
                            )}
                          </div>
                          <div className="file-info">
                            <div className="file-name" style={{ fontSize: '16px' }}>
                              {new Date(item.timestamp).toLocaleString()}
                            </div>
                            <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginTop: '4px' }}>
                              {item.candidate_count} Candidates  Top: {item.top_candidate || 'None'}
                            </div>
                            <div style={{ fontSize: '12px', color: 'var(--text-soft)', marginTop: '4px', fontStyle: 'italic' }}>
                              JD: {item.jd_preview}
                            </div>
                          </div>
                          <button className="btn btn-secondary" style={{ padding: '8px 16px', fontSize: '12px' }}>
                            View
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Floating Compare Button */}
            {selectedCandidates.length > 0 && (
              <button
                className="btn btn-primary compare-floating"
                onClick={compareCandidates}
                disabled={selectedCandidates.length !== 2 || comparing}
              >
                {comparing ? (
                  <>
                    <div className="spinner" style={{ width: 18, height: 18, borderWidth: 2 }}></div>
                    Comparing...
                  </>
                ) : (
                  <><Icons.Compare size={18} /> Compare ({selectedCandidates.length}/2)</>
                )}
              </button>
            )}

            {/* AI Report Modal */}
            {showReportModal && aiReport && (
              <div className="modal-overlay" onClick={() => setShowReportModal(false)}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '900px', maxHeight: '85vh', overflow: 'hidden', display: 'flex', flexDirection: 'column' }}>
                  <div className="modal-header">
                    <h2><Icons.Brain size={22} /> AI-Generated Hiring Report</h2>
                    <button className="modal-close" onClick={() => setShowReportModal(false)}></button>
                  </div>

                  <div style={{
                    flex: 1,
                    overflow: 'auto',
                    padding: '20px',
                    background: 'var(--bg-secondary)',
                    borderRadius: '8px',
                    margin: '0 0 16px 0',
                    fontSize: '14px',
                    lineHeight: '1.7',
                    whiteSpace: 'pre-wrap',
                    fontFamily: 'Inter, sans-serif'
                  }}>
                    {aiReport.split('\n').map((line, i) => {
                      if (line.startsWith('# ')) {
                        return <h2 key={i} style={{ color: 'var(--primary)', marginTop: '16px', marginBottom: '8px' }}>{line.replace('# ', '')}</h2>;
                      } else if (line.startsWith('## ')) {
                        return <h3 key={i} style={{ color: 'var(--text-primary)', marginTop: '14px', marginBottom: '6px' }}>{line.replace('## ', '')}</h3>;
                      } else if (line.startsWith('### ')) {
                        return <h4 key={i} style={{ color: 'var(--text-muted)', marginTop: '12px', marginBottom: '4px' }}>{line.replace('### ', '')}</h4>;
                      } else if (line.startsWith('**') && line.includes(':**')) {
                        const parts = line.split(':**');
                        return <p key={i}><strong style={{ color: 'var(--primary)' }}>{parts[0].replace('**', '')}:</strong>{parts[1]?.replace('**', '')}</p>;
                      } else if (line.trim() === '---') {
                        return <hr key={i} style={{ border: 'none', borderTop: '1px solid var(--border)', margin: '16px 0' }} />;
                      } else if (line.includes('') || line.includes('YES')) {
                        return <p key={i} style={{ color: 'var(--success)' }}>{line.replace(/\*\*/g, '')}</p>;
                      } else if (line.includes('') || line.includes('NO')) {
                        return <p key={i} style={{ color: 'var(--danger)' }}>{line.replace(/\*\*/g, '')}</p>;
                      } else if (line.includes('') || line.includes('MAYBE')) {
                        return <p key={i} style={{ color: 'var(--warning)' }}>{line.replace(/\*\*/g, '')}</p>;
                      } else {
                        return <p key={i} style={{ marginBottom: '8px' }}>{line.replace(/\*\*/g, '')}</p>;
                      }
                    })}
                  </div>

                  <div style={{ display: 'flex', gap: '12px' }}>
                    <button
                      className="btn btn-primary"
                      onClick={downloadReportPdf}
                      style={{ flex: 1 }}
                    >
                      <Icons.Document size={16} /> Download as PDF
                    </button>
                    <button
                      className="btn btn-secondary"
                      onClick={() => {
                        navigator.clipboard.writeText(aiReport);
                        alert('Report copied to clipboard!');
                      }}
                      style={{ flex: 1 }}
                    >
                      <Icons.Code size={16} /> Copy to Clipboard
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Comparison Modal */}
            {showCompareModal && comparisonResult && (
              <div className="modal-overlay" onClick={() => setShowCompareModal(false)}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '800px' }}>
                  <div className="modal-header">
                    <h2>Candidate Comparison</h2>
                    <button className="modal-close" onClick={() => setShowCompareModal(false)}></button>
                  </div>

                  {/* Visual Comparison Graph */}
                  <div className="comparison-chart-container" style={{ marginBottom: '24px', padding: '20px', background: 'var(--bg-secondary)', borderRadius: '12px' }}>
                    <h4 style={{ margin: '0 0 16px', fontSize: '14px', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Match Score Comparison</h4>

                    {/* Bar 1 */}
                    <div style={{ marginBottom: '16px' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px', fontSize: '14px' }}>
                        <span style={{ fontWeight: 600 }}>{comparisonResult.c1_name}</span>
                        <span style={{ fontWeight: 700 }}>{comparisonResult.c1_score}%</span>
                      </div>
                      <div style={{ width: '100%', height: '10px', background: 'rgba(255,255,255,0.1)', borderRadius: '5px', overflow: 'hidden' }}>
                        <div style={{
                          width: `${comparisonResult.c1_score}%`,
                          height: '100%',
                          background: 'linear-gradient(90deg, var(--primary) 0%, #a855f7 100%)',
                          borderRadius: '5px',
                          transition: 'width 1s ease-out'
                        }}></div>
                      </div>
                    </div>

                    {/* Bar 2 */}
                    <div>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px', fontSize: '14px' }}>
                        <span style={{ fontWeight: 600 }}>{comparisonResult.c2_name || 'Candidate 2'}</span>
                        <span style={{ fontWeight: 700 }}>{comparisonResult.c2_score || 0}%</span>
                      </div>
                      <div style={{ width: '100%', height: '10px', background: 'rgba(255,255,255,0.1)', borderRadius: '5px', overflow: 'hidden' }}>
                        <div style={{
                          width: `${comparisonResult.c2_score || 0}%`,
                          height: '100%',
                          background: 'linear-gradient(90deg, #ec4899 0%, #f472b6 100%)',
                          borderRadius: '5px',
                          transition: 'width 1s ease-out'
                        }}></div>
                      </div>
                    </div>
                  </div>

                  <div className="comparison-grid">
                    <div className="comparison-column" style={{ borderTop: '4px solid var(--primary)' }}>
                      <h4 style={{ color: 'var(--primary)' }}>{comparisonResult.c1_name}</h4>

                      <div style={{ marginBottom: '16px' }}>
                        <p style={{ fontSize: '12px', fontWeight: 700, color: 'var(--text-muted)', marginBottom: '8px', textTransform: 'uppercase' }}>Unique Strengths</p>
                        <div className="skills-row">
                          {comparisonResult.c1_unique?.length > 0 ? (
                            comparisonResult.c1_unique.map(s => (
                              <span key={s} className="skill" style={{ borderColor: 'var(--primary)', color: 'var(--primary)' }}>{s}</span>
                            ))
                          ) : (
                            <span style={{ color: 'var(--text-muted)', fontSize: '13px', fontStyle: 'italic' }}>None detected</span>
                          )}
                        </div>
                      </div>
                    </div>

                    <div className="comparison-column" style={{ borderTop: '4px solid #ec4899' }}>
                      <h4 style={{ color: '#ec4899' }}>{comparisonResult.c2_name || 'Candidate 2'}</h4>

                      <div style={{ marginBottom: '16px' }}>
                        <p style={{ fontSize: '12px', fontWeight: 700, color: 'var(--text-muted)', marginBottom: '8px', textTransform: 'uppercase' }}>Unique Strengths</p>
                        <div className="skills-row">
                          {comparisonResult.c2_unique?.length > 0 ? (
                            comparisonResult.c2_unique.map(s => (
                              <span key={s} className="skill" style={{ borderColor: '#ec4899', color: '#ec4899' }}>{s}</span>
                            ))
                          ) : (
                            <span style={{ color: 'var(--text-muted)', fontSize: '13px', fontStyle: 'italic' }}>None detected</span>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Shared Skills Section */}
                  <div style={{ marginTop: '20px', padding: '16px', background: 'var(--bg-secondary)', borderRadius: '8px', border: '1px dashed var(--border-color)' }}>
                    <h4 style={{ margin: '0 0 12px 0', fontSize: '14px', color: 'var(--text-primary)', display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icons.Users size={16} /> Shared Skills (Both Candidates)
                    </h4>
                    <div className="skills-row">
                      {comparisonResult.shared_skills?.length > 0 ? (
                        comparisonResult.shared_skills.map(s => (
                          <span key={s} className="skill" style={{ background: 'var(--success-subtle)', color: 'var(--success)', border: '1px solid var(--success)' }}>
                            <Icons.Check size={10} style={{ marginRight: 4 }} /> {s}
                          </span>
                        ))
                      ) : (
                        <span style={{ color: 'var(--text-muted)', fontSize: '13px' }}>No shared skills identified</span>
                      )}
                    </div>
                  </div>

                  <div className="comparison-recommendation">
                    <h5><Icons.Brain size={18} /> AI Recommendation</h5>
                    <div style={{ whiteSpace: 'pre-wrap' }}>{comparisonResult.recommendation}</div>
                  </div>
                </div>
              </div>
            )}

          </main>

          <footer className="footer">
            <p>ResumeAI Pro</p>
          </footer>
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>

</html>